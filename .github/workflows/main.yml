name: Deploy

on:
  push:
    branches:
      - dev
      - stage
      - main

env:
  DOCKER_COMPOSE_VERSION: 1.29.2

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ (github.ref == 'refs/heads/dev' && 'Development') || (github.ref == 'refs/heads/master' && 'Production') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Load SSH key
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Prepare
        id: set-env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            echo "::set-output name=ENVIRONMENT_NAME::dev"
          elif [ "${{ github.ref }}" == "refs/heads/stage" ]; then
            echo "::set-output name=ENVIRONMENT_NAME::stage"
          elif [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "::set-output name=ENVIRONMENT_NAME::production"
          fi

      - name: Deploying
        run: |
          ssh -T ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} /bin/bash <<'EOT'
          if ! docker ps | grep -q "php-film"; then
            echo "The container "php-film" is inactive"
            exit 1
          fi

          docker exec php-film bash -c "
            cd /var/www/;
            git reset --hard;
            git pull;
            rm -rf html;
            cp public html -r;
            node deploy.js;
          "
          EOT

        env:
          PORT: ${{ steps.set-env.outputs.PORT }}
          ENVIRONMENT_NAME: ${{ steps.set-env.outputs.ENVIRONMENT_NAME }}
